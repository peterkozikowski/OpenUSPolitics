name: Fetch Bill Metadata (Fast, No AI)

on:
  # Run daily at 1 AM UTC (before AI analysis at 2 AM)
  schedule:
    - cron: '0 1 * * *'

  # Allow manual triggering from Actions tab
  workflow_dispatch:
    inputs:
      bill_count:
        description: 'Number of bills to fetch'
        required: false
        default: '50'
        type: string

# Only run one fetch at a time
concurrency:
  group: bill-metadata-fetch
  cancel-in-progress: false

jobs:
  fetch:
    name: Fetch Bill Metadata
    runs-on: ubuntu-latest

    # Quick job - should complete in 2-3 minutes
    timeout-minutes: 15

    # Required permissions for committing changes
    permissions:
      contents: write

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Setup Python
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'pipeline/requirements.txt'

      # Step 3: Install dependencies (only what's needed for API calls)
      - name: Install dependencies
        run: |
          cd pipeline
          pip install --upgrade pip
          # Only install minimal dependencies for fetching
          pip install requests python-dotenv

      # Step 4: Configure environment
      - name: Configure environment
        run: |
          cd pipeline
          cat > .env << EOF
          CONGRESS_GOV_API_KEY=${{ secrets.CONGRESS_GOV_API_KEY }}
          BILLS_FETCH_LIMIT=${{ github.event.inputs.bill_count || '50' }}
          LOG_LEVEL=INFO
          EOF

      # Step 5: Run bill metadata fetcher (NO AI)
      - name: Fetch bill metadata
        run: |
          cd pipeline
          python fetch_bills.py \
            --bills ${{ github.event.inputs.bill_count || '50' }} \
            --verbose
        env:
          PYTHONUNBUFFERED: 1

      # Step 6: Check for changes
      - name: Check for data changes
        id: check_changes
        run: |
          cd pipeline
          if [[ -n $(git status --porcelain .) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ New bill metadata detected"
            git status --short
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âœ— No new bills to commit"
          fi

      # Step 7: Commit bill metadata
      - name: Commit bill metadata
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          cd pipeline

          # Configure git
          git config user.name "OpenUSPolitics Bot"
          git config user.email "bot@openuspolitics.org"

          # Add all data files
          git add .

          # Create commit
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          BILL_COUNT=$(ls data/bills/HR_*.json 2>/dev/null | wc -l)

          git commit -m "Update bill metadata - $TIMESTAMP

          - Fetched metadata for ${{ github.event.inputs.bill_count || '50' }} bills
          - Total bills in database: $BILL_COUNT
          - Automated metadata fetch (NO AI analysis yet)

          ðŸ¤– Generated by OpenUSPolitics.org Bill Fetcher"

          # Push changes
          git push

      # Step 8: Trigger website deployment
      - name: Trigger website deploy
        if: steps.check_changes.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'deploy-site'
            });
            console.log('âœ“ Triggered website deployment');

      # Step 9: Generate summary
      - name: Generate job summary
        if: always()
        run: |
          cd pipeline

          BILL_COUNT=$(ls data/bills/HR_*.json 2>/dev/null | wc -l || echo "0")
          LATEST_LOG=$(ls -t logs/fetch_bills_*.log 2>/dev/null | head -1 || echo "none")

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“Š Bill Metadata Fetch Report

          ## Summary
          - **Date**: $(date -u +"%Y-%m-%d %H:%M UTC")
          - **Bills Requested**: ${{ github.event.inputs.bill_count || '50' }}
          - **Total Bills in Database**: $BILL_COUNT
          - **Status**: ${{ job.status }}
          - **Changes Committed**: ${{ steps.check_changes.outputs.changes || 'N/A' }}

          ## What This Does
          - âœ“ Fetch bill metadata from Congress.gov API (title, sponsor, date, status)
          - âœ“ Filter out post office naming bills
          - âœ“ Save lightweight JSON files (NO AI analysis)
          - âœ“ Update metadata index
          - âœ“ Trigger website deployment

          ## Performance
          - **Fast**: ~2-3 minutes for 50 bills
          - **Cheap**: Just API calls, no AI tokens
          - **Updates website immediately** with bill list

          ## Next Steps
          - Bills are visible on the website without analysis
          - Run AI analysis workflow manually to enrich bills
          - AI analysis will add summaries and detailed breakdowns
          EOF

          if [ -f "$LATEST_LOG" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Latest Log Excerpt" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -20 "$LATEST_LOG" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      # Step 10: Upload logs
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fetch-logs-${{ github.run_number }}
          path: |
            pipeline/logs/fetch_bills_*.log
            pipeline/logs/fetch_summary_*.json
          retention-days: 7

      # Step 11: Notify on failure
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Bill metadata fetch failed! Check logs for details."
          echo "Failed at: $(date -u)"
